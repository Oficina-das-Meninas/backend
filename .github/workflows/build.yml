name: Deploy Spring Boot na VM

on:
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: 'Selecione o ambiente'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # =============================================================
      #  GERAR application.properties usando SECRETS DO GITHUB
      # =============================================================
      - name: Injetar application.properties
        run: |
          mkdir -p src/main/resources

          if [[ "${{ github.event.inputs.ENVIRONMENT }}" == "development" ]]; then
            echo "${{ secrets.APPLICATION_DEVELOPMENT_PROPERTIES }}" > src/main/resources/application.properties
          else
            echo "${{ secrets.APPLICATION_PRODUCTION_PROPERTIES }}" > src/main/resources/application.properties
          fi

      # Debug opcional
      - name: Mostrar resources
        run: ls -lah src/main/resources/

      # =============================================================
      #  BUILD DO SPRING BOOT
      # =============================================================
      - name: Build Spring Boot
        run: mvn clean package -DskipTests

      # Debug opcional
      - name: Debug â€“ arquivos gerados
        run: ls -lah target/

      # =============================================================
      #  UPLOAD DOS ARTEFATOS
      # =============================================================
      - name: Upload artefatos
        uses: actions/upload-artifact@v4
        with:
          name: springboot-build
          path: |
            target/*.jar


  # =============================================================
  #  DEPLOY
  # =============================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artefatos
        uses: actions/download-artifact@v4
        with:
          name: springboot-build
          path: build/

      # Debug opcional
      - name: Debug â€“ arquivos baixados
        run: ls -lah build/

      # =============================================================
      #  SSH
      # =============================================================
      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ vars.VM_HOST }} >> ~/.ssh/known_hosts

      # =============================================================
      #  DEPLOY NA VM
      # =============================================================
      - name: Enviar artefatos e reiniciar serviÃ§o
        run: |
          VM_USER="${{ vars.VM_USER }}"
          VM_HOST="${{ vars.VM_HOST }}"

          if [[ "${{ github.event.inputs.ENVIRONMENT }}" == "development" ]]; then
            DEST_DIR="${{ vars.VM_DIR_DEV }}"
            SERVICE_NAME="${{ vars.SERVICE_DEV_NAME }}"
          else
            DEST_DIR="${{ vars.VM_DIR_PRD }}"
            SERVICE_NAME="${{ vars.SERVICE_PRD_NAME }}"
          fi

          echo "ðŸ“¤ Enviando arquivos para $VM_USER@$VM_HOST:$DEST_DIR ..."
          rsync -avz --delete build/*.jar $VM_USER@$VM_HOST:$DEST_DIR/

          echo "ðŸ”„ Reiniciando serviÃ§o $SERVICE_NAME ..."
          ssh $VM_USER@$VM_HOST "systemctl restart $SERVICE_NAME"

          echo "âœ… ImplantaÃ§Ã£o concluÃ­da com sucesso!"
